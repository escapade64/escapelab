<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brescapade</title>
    <link rel="icon" href="images/bar.png" type="image/icon type">
    <link rel="apple-touch-icon" href="images/bar.png" type="image/icon type">
    <link rel="stylesheet" href="css/style.css">
    <style>
    </style>
</head>

<body>
    <h1><a href="maree.html"> <img src="images/bar.png"  width=25% height=25% ></a> Keranguilis - Planning </h1>
    <div id="date"></div>
    <br>
    <div id="horloge"></div>


  
    <div id="Update"></div>


    <br>
    <div id="contenu"></div>
    <br>
    <div id="corps"></div>
    <br>
    <div id="kerpont"></div>
    <br>
    
    <br>
    <br>
    <br>

    <script>
 
        // lien vers fichier de données marée, en Json Unix Timestamp en ms et hauteur en m
        // voir fichier Getmarée.xls dans le dossier OneDrive/Escapelab/Brescapade
        mareefile='json/tidedata.json';
 
        // API key Meteo Blue Free Weather API : RjWhm28CVvqGYbkA

        // tableaux de données (initiatlisation)

        let maree =[];

        let mareeb=[];


        // marge de tirant d'eau bateau (en m) à ajouter aux données de hauteur
        let marge =0.5;
        
        // hauteurs d'eau des différents points d'intérêt
        
        // OUEST Bréhat
        // Corps mort corderie
        let hcorps=4.1;
        // Kerpont hauteur mesurée 2.6 donné ici sans marge, c'est aussi la cale de l'Arcouest
        let hkerpont=2.6; 
        // Passage Beniguet pour contourner Kerpont
        let hbeniguet=4.2; 
        let hbaie =5.4;
        let hsudmaudez=6.0;
        let hnordmaudez=8.0;
        
        // EST Bréhat
        let hcrouezen= 8.0;
        let hcalifornia= 4.8;

        // PAIMPOL Port à sec 
        let hportasec=5.6;

        let hheaux=7.5;
        
        // Récupération des zones d'affichage
        const dateDiv = document.getElementById('date');     
        const horlogeDiv = document.getElementById('horloge'); 
        const contenuDiv = document.getElementById('contenu');
        const corpsDiv = document.getElementById('corps');
        const kerpontDiv = document.getElementById('kerpont');
        const donneesDiv = document.getElementById('database');
        const updateDiv = document.getElementById('Update');

        function creertableau(data) {

            // Créer un tableau HTML
            const table = document.createElement('table');
            let i = 0;
            let j = 0;
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                j = 0;
                let mareebRow = []; // Créer une nouvelle ligne pour mareeb
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                    mareebRow.push(parseFloat(cell)); // Ajouter la cellule à la ligne de mareeb
                    j++;
                });
                table.appendChild(tr);
                mareeb.push(mareebRow); // Ajouter la ligne à la matrice mareeb
                i++;
            });

        }

        // Fonction qui retourne la date complète
        function getDateComplete(now)
        {
            // Tableau des jours de la semaine en français
            const joursSemaine = ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
            
            // Obtenir le jour de la semaine
            let jour = joursSemaine[now.getDay()];
            
            // Tableau des mois de l'année en français
            const moisAnnee = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
            
            // Obtenir le jour de la semaine, le jour du mois, le mois et l'année
            let jourSemaine = joursSemaine[now.getDay()];
            let jourMois = now.getDate();
            let mois = moisAnnee[now.getMonth()];
            let annee = now.getFullYear();
 
            // Assembler la date complète
            let dateComplete = `${jourSemaine} ${jourMois} ${mois} ${annee}`;

            return dateComplete;
        }
        // Fonction qui permet d'afficher l'heure
        function haff(date)
        {
            let hours = date.getHours();
            let minutes = date.getMinutes();

            // Format pour afficher l'heure en hh:mm
            let formattedTime = `${hours.toString().padStart(2, '0')}h${minutes.toString().padStart(2, '0')}`;
            return formattedTime;
        }

     
        function afficheJournee(now) // quand = date en unix
        {
           
            // afficher la date
            dateComplete = getDateComplete(now);
            dateDiv.innerHTML += "<u>"+dateComplete + "</u><br>" ;
     
            // Le tableau ligne va prendre les marées du jour (5 au max)
            // let ligne = [0,0,0,0,0];  

            // récupère l'heure de la date en UNIX 
            const heureactuelle = now.getTime();

            let debut=0;

            for (let i = 0; i < mareeb.length; i++) 
            {    
                if (mareeb[i][0] <= heureactuelle) {
                    debut = i;
                } else if (mareeb[i][0] > heureactuelle && debut === 0) {
                    break; // Exit loop as we only need the first occurrence after
                }
            }

            // Affiche les marées du jour 
            let aff="";
            
            for (choix=1; choix < (mareeb.length - choix); choix++)
            {
                let date1= new Date(mareeb[debut+choix][0]);
                if (date1.getDay() !== now.getDay()) {
                    dateComplete = getDateComplete(date1);
                    dateDiv.innerHTML += "<u>"+ dateComplete + "</u><br>";
                    now.setDate(now.getDate() + 1)
                }
        
                if ( mareeb[debut+choix][1] < mareeb[debut+choix+1][1] ) 
                {
                    aff="Basse " ;
                }
                else 
                {
                    aff="Pleine ";
                }
                dateDiv.innerHTML += aff + "mer...: " + haff(date1) + "    hauteur : " + mareeb[debut+choix][1] + "m" + "<br><br>";
            }
           
        }


        // idée : faire une fonction qui renvoie la data (BM PM Horaire précsie) puis faire un fonction séparée qui affiche
        // ensuite on affiche dans un carré en fonction de l'horaire que l'on choisit (choix de date et heure)
        // On peut également faire un carré avec les horaires de la journée 

        // Appeler la fonction pour lire et afficher le fichier JSON
       
        async function chargerDonnees() 
        {
        try 
            {
            const response = await fetch(mareefile);
            if (!response.ok)
                {
                throw new Error('Network response was not ok');
                }

                maree = await response.json(); // Stocker les données dans la variable globale

                // permet de peupler le tableau mareeb en format tableau 
                creertableau(maree);
                
                const aujourdhui = new Date(); 
                aujourdhui.setHours(0, 0, 0, 0);
 
                afficheJournee(aujourdhui);

            } 
            catch (error)
            {
            document.write('Erreur de récupération des données:', error);
            }
        }
            
            chargerDonnees();

            
        
    </script>
</body>
</html>
